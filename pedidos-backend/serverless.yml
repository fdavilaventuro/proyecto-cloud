org: ${file(../serverless.vars.yml):org}
service: pedidos-api

provider:
  name: aws
  runtime: python3.9
  region: ${opt:region, 'us-east-1'}
  memorySize: 256
  timeout: 30
  iam:
    role: arn:aws:iam::${file(../serverless.vars.yml):accountId}:role/${file(../serverless.vars.yml):labRole}
  # Additional inline role statements to scope Lambda permissions (LabRole remains the execution role)
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:PutItem
        - dynamodb:GetItem
        - dynamodb:UpdateItem
        - dynamodb:Query
        - dynamodb:Scan
      Resource:
        - arn:aws:dynamodb:${self:provider.region}:${file(../serverless.vars.yml):accountId}:table/${self:provider.environment.PEDIDOS_TABLE}
        - arn:aws:dynamodb:${self:provider.region}:${file(../serverless.vars.yml):accountId}:table/${self:provider.environment.USERS_TABLE}
        - arn:aws:dynamodb:${self:provider.region}:${file(../serverless.vars.yml):accountId}:table/${self:provider.environment.USERS_TABLE}/index/*
    - Effect: Allow
      Action:
        - sqs:SendMessage
        - sqs:ReceiveMessage
        - sqs:DeleteMessage
        - sqs:GetQueueAttributes
      Resource:
        - arn:aws:sqs:${self:provider.region}:${file(../serverless.vars.yml):accountId}:${self:provider.environment.SQS_QUEUE}
    - Effect: Allow
      Action:
        - states:StartExecution
      Resource:
        - arn:aws:states:${self:provider.region}:${file(../serverless.vars.yml):accountId}:stateMachine:*
    - Effect: Allow
      Action:
        - events:PutEvents
      Resource:
        - arn:aws:events:${self:provider.region}:${file(../serverless.vars.yml):accountId}:event-bus/orders-bus
    - Effect: Allow
      Action:
        - logs:CreateLogGroup
        - logs:CreateLogStream
        - logs:PutLogEvents
      Resource:
        - arn:aws:logs:${self:provider.region}:${file(../serverless.vars.yml):accountId}:* 
  environment:
    STAGE: ${opt:stage, 'dev'}
    PEDIDOS_TABLE: ${self:service}-${self:provider.environment.STAGE}-pedidos
    MENU_TABLE: ${self:service}-${self:provider.environment.STAGE}-menu
    LOCALES_TABLE: ${self:service}-${self:provider.environment.STAGE}-locales
    USERS_TABLE: ${self:service}-${self:provider.environment.STAGE}-users
    SQS_QUEUE: ${self:service}-${self:provider.environment.STAGE}-pedidos-queue
    # Read STEP_FUNCTION_ARN exported by the kfc-workflow stack (if deployed)
    STEP_FUNCTION_ARN: ${cf:kfc-workflow-${opt:stage, 'dev'}.KfcOrderFlowArn, ''}
    EVENT_BUS: orders-bus
    # JWT settings for auth (use Secrets Manager/SSM in prod)
    JWT_SECRET: ${opt:jwtSecret, 'dev-secret-change-me'}
    JWT_ISSUER: pedidos-backend

plugins:
  - serverless-python-requirements

custom:
  sqsQueueName: ${self:provider.environment.SQS_QUEUE}
  sqsDLQName: ${self:provider.environment.SQS_QUEUE}-dlq
  pythonRequirements:
    dockerizePip: false
    slim: true
    pythonBin: python3

functions:
  login:
    handler: lambdas.auth.login.lambda_handler
    events:
      - http:
          path: /auth/login
          method: post
          cors: true

  register:
    handler: lambdas.auth.register.lambda_handler
    events:
      - http:
          path: /auth/register
          method: post
          cors: true

  autorizador:
    handler: lambdas.autorizador.lambda_handler

  registro:
    handler: lambdas.pedidos.registro.lambda_handler
    events:
      - http:
          path: /order
          method: post
          cors: true
          authorizer:
            type: token
            name: autorizador
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 0

  status:
    handler: lambdas.pedidos.status.lambda_handler
    events:
      - http:
          path: /status
          method: get
          cors: true
          authorizer:
            type: token
            name: autorizador
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 0

  procesamiento:
    handler: lambdas.procesamiento.procesamiento.lambda_handler
    events:
      - sqs:
          arn:
            'Fn::GetAtt': [ PedidosQueue, Arn ]

  menu:
    handler: lambdas.menu.menu.lambda_handler
    events:
      - http:
          path: /menu
          method: get
          cors: true
          authorizer:
            type: token
            name: autorizador
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 0

  locales:
    handler: lambdas.inicializar_datos.lambda_handler
    events:
      - http:
          path: /locales/init
          method: post
          cors: true
          authorizer:
            type: token
            name: autorizador
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 0

  # Employee endpoints for manual status updates
  kitchenReady:
    handler: lambdas.pedidos.employee.mark_kitchen_ready
    events:
      - http:
          path: /employee/order/{id}/kitchen-ready
          method: put
          cors: true
          authorizer:
            type: token
            name: autorizador
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 0

  packed:
    handler: lambdas.pedidos.employee.mark_packed
    events:
      - http:
          path: /employee/order/{id}/packed
          method: put
          cors: true
          authorizer:
            type: token
            name: autorizador
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 0

  delivering:
    handler: lambdas.pedidos.employee.assign_delivery
    events:
      - http:
          path: /employee/order/{id}/deliver
          method: put
          cors: true
          authorizer:
            type: token
            name: autorizador
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 0

  getOrders:
    handler: lambdas.pedidos.employee.get_orders
    events:
      - http:
          path: /employee/orders
          method: get
          cors: true
          authorizer:
            type: token
            name: autorizador
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 0

resources:
  Resources:
    PedidosTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.PEDIDOS_TABLE}
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: storeId
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        GlobalSecondaryIndexes:
          - IndexName: StoreIndex
            KeySchema:
              - AttributeName: storeId
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    MenuTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.MENU_TABLE}
        AttributeDefinitions:
          - AttributeName: productId
            AttributeType: S
          - AttributeName: store
            AttributeType: S
        KeySchema:
          - AttributeName: productId
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        GlobalSecondaryIndexes:
          - IndexName: StoreMenuIndex
            KeySchema:
              - AttributeName: store
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    LocalesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.LOCALES_TABLE}
        AttributeDefinitions:
          - AttributeName: storeId
            AttributeType: S
        KeySchema:
          - AttributeName: storeId
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.USERS_TABLE}
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        GlobalSecondaryIndexes:
          - IndexName: EmailIndex
            KeySchema:
              - AttributeName: email
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    PedidosQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.sqsQueueName}
        VisibilityTimeout: 300
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt PedidosDLQ.Arn
          maxReceiveCount: 3

    PedidosDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.sqsDLQName}
        MessageRetentionPeriod: 1209600

  Outputs:
    ApiUrl:
      Description: "URL del API Gateway"
      Value: !Sub "https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/${sls:stage}"
      Export:
        Name: "PedidosApiUrl-${opt:stage, 'dev'}"
    PedidosTableName:
      Description: "DynamoDB Pedidos table name"
      Value: !Ref PedidosTable
      Export:
        Name: "PedidosTableName-${opt:stage, 'dev'}"
    PedidosQueueName:
      Description: "SQS queue name for pedidos"
      Value: !Ref PedidosQueue
      Export:
        Name: "PedidosQueueName-${opt:stage, 'dev'}"
    PedidosQueueArn:
      Description: "SQS queue ARN for pedidos"
      Value: !GetAtt PedidosQueue.Arn
      Export:
        Name: "PedidosQueueArn-${opt:stage, 'dev'}"

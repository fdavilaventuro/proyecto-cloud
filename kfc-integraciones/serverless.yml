org: fabioedv
service: kfc-integraciones

provider:
  name: aws
  runtime: python3.12
  region: us-east-1
  iam:
    role: arn:aws:iam::${file(../serverless.vars.yml):accountId}:role/${file(../serverless.vars.yml):labRole}
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:GetItem
        - dynamodb:UpdateItem
        - dynamodb:Query
      Resource:
        - arn:aws:dynamodb:${self:provider.region}:${file(../serverless.vars.yml):accountId}:table/${self:provider.environment.TABLE_NAME}
    - Effect: Allow
      Action:
        - events:PutEvents
      Resource:
        - arn:aws:events:${self:provider.region}:${file(../serverless.vars.yml):accountId}:event-bus/${self:provider.environment.EVENT_BUS}
    - Effect: Allow
      Action:
        - sns:Publish
      Resource:
        - arn:aws:sns:${self:provider.region}:${file(../serverless.vars.yml):accountId}:orders-notifications
    - Effect: Allow
      Action:
        - logs:CreateLogGroup
        - logs:CreateLogStream
        - logs:PutLogEvents
      Resource:
        - arn:aws:logs:${self:provider.region}:${file(../serverless.vars.yml):accountId}:*
  environment:
    # Read TABLE_NAME from pedidos-backend and EVENT_BUS from kfc-workflow
    TABLE_NAME: ${cf:pedidos-api-${opt:stage, 'dev'}.PedidosTableName}
    EVENT_BUS: ${cf:kfc-workflow-${opt:stage, 'dev'}.OrdersEventBusName, 'orders-bus'}
    # Function-specific environment is set for SNS topic; avoid reserved keys at provider level

resources:
  Resources:

    # Note: Pedidos table is owned by pedidos-backend, EventBus by kfc-workflow.
    # This stack listens to events and can trigger notifications (email, SMS, push) in the future.

    # -------------------------------
    # EventBridge Rules
    # -------------------------------
    OrderReadyRule:
      Type: AWS::Events::Rule
      Properties:
        Name: order-ready
        EventBusName: !Sub ${self:provider.environment.EVENT_BUS}
        EventPattern:
          detail-type:
            - ORDER.READY
        Targets:
          - Arn: !GetAtt NotificationUnderscorehandlerLambdaFunction.Arn
            Id: notif-ready-target

    OrderPaidRule:
      Type: AWS::Events::Rule
      Properties:
        Name: order-paid
        EventBusName: !Sub ${self:provider.environment.EVENT_BUS}
        EventPattern:
          detail-type:
            - ORDER.PAID
        Targets:
          - Arn: !GetAtt NotificationUnderscorehandlerLambdaFunction.Arn
            Id: notif-paid-target

    # -------------------------------
    # EventBridge â†’ Lambda permissions
    # -------------------------------
    PermissionReady:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !GetAtt NotificationUnderscorehandlerLambdaFunction.Arn
        Action: lambda:InvokeFunction
        Principal: events.amazonaws.com
        SourceArn: !GetAtt OrderReadyRule.Arn

    PermissionPaid:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !GetAtt NotificationUnderscorehandlerLambdaFunction.Arn
        Action: lambda:InvokeFunction
        Principal: events.amazonaws.com
        SourceArn: !GetAtt OrderPaidRule.Arn

    OrdersNotificationsTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: orders-notifications

  Outputs:
    OrdersNotificationsTopicArn:
      Description: "SNS Topic ARN for order notifications"
      Value: !Ref OrdersNotificationsTopic
      Export:
        Name: "OrdersNotificationsTopicArn-${opt:stage, 'dev'}"

functions:

  # -------------------------------------
  # Event-driven notifications handler
  # Listens to EventBridge events and can send emails/SMS/push notifications
  # -------------------------------------
  notification_handler:
    handler: notifications.lambda_handler
    description: Handles ORDER.PAID and ORDER.READY events for customer notifications
    environment:
      SNS_TOPIC_ARN:
        Ref: OrdersNotificationsTopic
